# 数据处理节点

<cite>
**本文档引用的文件**
- [AssignerNode.java](file://spring-boot-starters/spring-ai-alibaba-starter-builtin-nodes/src/main/java/com/alibaba/cloud/ai/graph/node/AssignerNode.java)
- [VariableAggregatorNode.java](file://spring-boot-starters/spring-ai-alibaba-starter-builtin-nodes/src/main/java/com/alibaba/cloud/ai/graph/node/VariableAggregatorNode.java)
- [ListOperatorNode.java](file://spring-boot-starters/spring-ai-alibaba-starter-builtin-nodes/src/main/java/com/alibaba/cloud/ai/graph/node/ListOperatorNode.java)
- [AssignerNodeTest.java](file://spring-boot-starters/spring-ai-alibaba-starter-builtin-nodes/src/test/java/com/alibaba/cloud/ai/graph/node/AssignerNodeTest.java)
- [VariableAggregatorNodeTest.java](file://spring-boot-starters/spring-ai-alibaba-starter-builtin-nodes/src/test/java/com/alibaba/cloud/ai/graph/node/VariableAggregatorNodeTest.java)
- [ListOperatorNodeTest.java](file://spring-boot-starters/spring-ai-alibaba-starter-builtin-nodes/src/test/java/com/alibaba/cloud/ai/graph/node/ListOperatorNodeTest.java)
</cite>

## 目录
1. [简介](#简介)
2. [核心数据处理节点](#核心数据处理节点)
3. [AssignerNode：状态赋值节点](#assignernode状态赋值节点)
4. [VariableAggregatorNode：变量聚合节点](#variableaggregatornode变量聚合节点)
5. [ListOperatorNode：列表操作节点](#listoperatornode列表操作节点)
6. [节点组合应用示例](#节点组合应用示例)
7. [总结](#总结)

## 简介
本文档系统性地介绍了Spring AI Alibaba框架中用于数据操作的内置数据处理节点。这些节点是构建复杂工作流的核心组件，允许开发者在工作流执行过程中对状态进行精确的控制和操作。文档将详细说明AssignerNode如何将值或表达式结果赋给状态中的特定键，解释VariableAggregatorNode如何从多个分支或迭代中收集和合并数据，以及阐述ListOperatorNode支持的列表操作，如映射、过滤、排序和聚合。通过清晰的配置示例和表达式语法说明，展示如何组合使用这些节点来实现复杂的数据转换和聚合逻辑。

## 核心数据处理节点
Spring AI Alibaba框架提供了一套强大的内置节点，用于在工作流中进行数据处理。这些节点作为`NodeAction`接口的实现，可以无缝集成到`StateGraph`中，通过定义明确的输入、处理逻辑和输出来操作工作流的全局状态（`OverAllState`）。核心的数据处理节点包括：
- **AssignerNode**: 用于将值从一个状态键复制或赋值到另一个状态键，支持多种写入模式。
- **VariableAggregatorNode**: 用于从工作流的不同路径或迭代中收集多个变量，并将它们合并成一个结构化的输出。
- **ListOperatorNode**: 专门用于对列表数据进行过滤、排序、限制和转换等操作。

这些节点共同构成了工作流中数据转换和聚合的基础能力。

## AssignerNode：状态赋值节点
`AssignerNode`是工作流中最基础的数据操作节点，其核心功能是将值从一个状态键（`inputKey`）复制或赋值到另一个状态键（`targetKey`），或者直接将一个常量值（`inputValue`）赋给目标键。它通过`WriteMode`枚举定义了四种不同的写入模式，提供了灵活的状态管理能力。

### 写入模式
`AssignerNode`支持以下四种写入模式：

1.  **OVER_WRITE (覆盖写入)**: 将源键的值直接覆盖到目标键。如果目标键不存在，则创建它。
2.  **APPEND (追加写入)**: 将源键的值追加到目标键的值中。此模式要求目标键的值必须是`List`类型。如果源值也是`List`，则将其所有元素追加；如果源值是单个对象，则将其作为单个元素追加。
3.  **CLEAR (清空)**: 将目标键的值清空。根据目标值的类型，清空操作会将其重置为相应的空值（如空列表、空字符串、0等）。
4.  **INPUT_CONSTANT (常量输入)**: 将一个预定义的常量值直接赋给目标键，与源键无关。

### 配置与使用
`AssignerNode`提供了流畅的构建器（Builder）模式来配置其行为。以下是一个配置示例：

```java
AssignerNode node = AssignerNode.builder()
    .addItem("output", "input", AssignerNode.WriteMode.OVER_WRITE) // 将input的值覆盖到output
    .addItem("user_list", "new_user", AssignerNode.WriteMode.APPEND) // 将new_user追加到user_list
    .addConst("status", "processing") // 将常量"processing"赋给status
    .addItem("temp_data", null, AssignerNode.WriteMode.CLEAR) // 清空temp_data
    .build();
```

在上述示例中，`AssignerNode`会执行一系列操作：将`input`键的值复制到`output`，将`new_user`的值追加到`user_list`列表中，将`status`设置为"processing"，并清空`temp_data`。这使得在工作流的特定阶段对状态进行批量更新和清理变得非常方便。

**节点来源**
- [AssignerNode.java](file://spring-boot-starters/spring-ai-alibaba-starter-builtin-nodes/src/main/java/com/alibaba/cloud/ai/graph/node/AssignerNode.java#L32-L175)
- [AssignerNodeTest.java](file://spring-boot-starters/spring-ai-alibaba-starter-builtin-nodes/src/test/java/com/alibaba/cloud/ai/graph/node/AssignerNodeTest.java#L35-L155)

## VariableAggregatorNode：变量聚合节点
`VariableAggregatorNode`专门用于解决在并行执行或循环迭代后，需要将分散在不同路径或多次迭代中的数据收集并合并的问题。它能够从全局状态中提取多个变量，并将它们聚合成一个单一的输出，通常用于汇总结果。

### 核心功能
该节点的核心功能是通过指定一个变量路径列表（`variables`）来收集数据。每个路径是一个`List<String>`，用于访问嵌套状态。例如，路径`["user", "name"]`表示从`user`对象中获取`name`属性。收集到的所有值会被聚合到一个输出键（`outputKey`）下。

### 输出类型与分组
`VariableAggregatorNode`支持两种主要的输出格式：
- **list**: 将所有收集到的值合并成一个列表。
- **string**: 将所有收集到的值转换为字符串，并用换行符连接。

此外，通过`AdvancedSettings`，节点还支持**分组聚合**。可以定义多个`Group`，每个`Group`包含一组变量路径和一个组名。最终的输出将是一个以组名为键的映射，每个键对应一个聚合后的值列表。

### 配置与使用
以下是一个使用`VariableAggregatorNode`进行分组聚合的配置示例：

```java
VariableAggregatorNode.Group userInfoGroup = new VariableAggregatorNode.Group();
userInfoGroup.setGroupName("UserInfo");
userInfoGroup.setVariables(Arrays.asList(
    Arrays.asList("user", "name"), 
    Arrays.asList("user", "age")
));

VariableAggregatorNode.Group productInfoGroup = new VariableAggregatorNode.Group();
productInfoGroup.setGroupName("ProductInfo");
productInfoGroup.setVariables(Collections.singletonList(Collections.singletonList("product")));

VariableAggregatorNode.AdvancedSettings settings = new VariableAggregatorNode.AdvancedSettings();
settings.setGroupEnabled(true);
settings.setGroups(Arrays.asList(userInfoGroup, productInfoGroup));

VariableAggregatorNode node = VariableAggregatorNode.builder()
    .variables(Arrays.asList(
        Arrays.asList("user", "name"), 
        Arrays.asList("user", "age"), 
        Collections.singletonList("product")
    ))
    .outputKey("aggregatedData")
    .advancedSettings(settings)
    .build();
```

在此配置中，节点会创建一个名为`aggregatedData`的输出，其中包含`UserInfo`和`ProductInfo`两个分组，每个分组内包含其指定的变量值。

**节点来源**
- [VariableAggregatorNode.java](file://spring-boot-starters/spring-ai-alibaba-starter-builtin-nodes/src/main/java/com/alibaba/cloud/ai/graph/node/VariableAggregatorNode.java#L26-L210)
- [VariableAggregatorNodeTest.java](file://spring-boot-starters/spring-ai-alibaba-starter-builtin-nodes/src/test/java/com/alibaba/cloud/ai/graph/node/VariableAggregatorNodeTest.java#L34-L132)

## ListOperatorNode：列表操作节点
`ListOperatorNode`是一个功能强大的节点，专门用于对列表、数组或JSON字符串形式的列表数据进行复杂的操作。它支持过滤（Filter）、排序（Sort）、限制（Limit）和类型转换等操作，是实现数据筛选和转换逻辑的理想选择。

### 操作模式
该节点通过`Mode`枚举支持三种输入/输出模式：
- **JSON_STR**: 输入和输出均为JSON格式的字符串。
- **LIST**: 输入和输出均为`List`对象。
- **ARRAY**: 输入和输出均为数组。

### 支持的操作
`ListOperatorNode`支持以下操作：
- **过滤 (Filter)**: 使用`Predicate<T>`函数来定义过滤条件。只有满足条件的元素才会被保留。
- **排序 (Sort)**: 使用`Comparator<T>`函数来定义排序规则。支持链式比较器。
- **限制 (Limit)**: 通过`limitNumber`参数限制输出结果的最大数量。

### 配置与使用
`ListOperatorNode`同样采用构建器模式进行配置。以下是一个对字符串列表进行过滤和排序的示例：

```java
ListOperatorNode<String> node = ListOperatorNode.<String>builder()
    .mode(ListOperatorNode.Mode.LIST)
    .inputKey("input")
    .outputKey("output")
    .filter(x -> x.startsWith("1234")) // 保留以"1234"开头的字符串
    .filter(x -> x.length() > 4) // 保留长度大于4的字符串
    .comparator(String::compareTo) // 按字典序升序排列
    .limitNumber(10) // 最多返回10个结果
    .build();
```

对于JSON字符串输入，必须通过`elementClassType(Class<T> type)`方法指定列表中元素的具体类型，以便节点能够正确地进行反序列化。

**节点来源**
- [ListOperatorNode.java](file://spring-boot-starters/spring-ai-alibaba-starter-builtin-nodes/src/main/java/com/alibaba/cloud/ai/graph/node/ListOperatorNode.java#L37-L211)
- [ListOperatorNodeTest.java](file://spring-boot-starters/spring-ai-alibaba-starter-builtin-nodes/src/test/java/com/alibaba/cloud/ai/graph/node/ListOperatorNodeTest.java#L39-L157)

## 节点组合应用示例
在实际应用中，这些数据处理节点通常会组合使用，以实现更复杂的业务逻辑。例如，可以构建一个工作流来处理并行搜索任务的结果：

1.  **并行搜索**: 使用`ParallelAgent`并行执行多个搜索任务，每个任务的结果存储在不同的状态键中（如`search_result_1`, `search_result_2`）。
2.  **结果聚合**: 使用`VariableAggregatorNode`将`search_result_1`和`search_result_2`的值收集到一个名为`all_results`的列表中。
3.  **数据清洗**: 使用`ListOperatorNode`对`all_results`列表进行操作，例如过滤掉重复项、按相关性排序，并限制最终结果为前10条。
4.  **状态更新**: 使用`AssignerNode`将清洗后的结果赋值给`final_results`键，并清空临时的`all_results`键。

这种组合方式使得开发者能够构建出高度灵活和可复用的数据处理管道，极大地提升了工作流的开发效率和可维护性。

## 总结
`AssignerNode`、`VariableAggregatorNode`和`ListOperatorNode`是Spring AI Alibaba框架中不可或缺的数据处理组件。`AssignerNode`提供了基础的状态赋值能力，`VariableAggregatorNode`解决了分布式数据的聚合问题，而`ListOperatorNode`则为列表数据的复杂操作提供了强大支持。通过理解这些节点的配置方式和使用场景，并将它们灵活组合，开发者可以构建出能够处理复杂数据转换和聚合逻辑的智能工作流，从而满足多样化的业务需求。