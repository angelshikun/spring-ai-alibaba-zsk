# 工作流代理

<cite>
**本文档中引用的文件**  
- [FlowAgent.java](file://spring-ai-alibaba-agent-framework/src/main/java/com/alibaba/cloud/ai/graph/agent/flow/agent/FlowAgent.java)
- [SequentialAgent.java](file://spring-ai-alibaba-agent-framework/src/main/java/com/alibaba/cloud/ai/graph/agent/flow/agent/SequentialAgent.java)
- [ParallelAgent.java](file://spring-ai-alibaba-agent-framework/src/main/java/com/alibaba/cloud/ai/graph/agent/flow/agent/ParallelAgent.java)
- [SupervisorAgent.java](file://spring-ai-alibaba-agent-framework/src/main/java/com/alibaba/cloud/ai/graph/agent/flow/agent/SupervisorAgent.java)
- [LlmRoutingAgent.java](file://spring-ai-alibaba-agent-framework/src/main/java/com/alibaba/cloud/ai/graph/agent/flow/agent/LlmRoutingAgent.java)
- [LoopAgent.java](file://spring-ai-alibaba-agent-framework/src/main/java/com/alibaba/cloud/ai/graph/agent/flow/agent/LoopAgent.java)
- [ParallelResultAggregator.java](file://spring-ai-alibaba-agent-framework/src/main/java/com/alibaba/cloud/ai/graph/agent/flow/node/ParallelResultAggregator.java)
- [EnhancedParallelResultAggregator.java](file://spring-ai-alibaba-agent-framework/src/main/java/com/alibaba/cloud/ai/graph/agent/flow/node/EnhancedParallelResultAggregator.java)
- [FlowGraphBuilder.java](file://spring-ai-alibaba-agent-framework/src/main/java/com/alibaba/cloud/ai/graph/agent/flow/builder/FlowGraphBuilder.java)
- [CountLoopStrategy.java](file://spring-ai-alibaba-agent-framework/src/main/java/com/alibaba/cloud/ai/graph/agent/flow/agent/loop/CountLoopStrategy.java)
- [ConditionLoopStrategy.java](file://spring-ai-alibaba-agent-framework/src/main/java/com/alibaba/cloud/ai/graph/agent/flow/agent/loop/ConditionLoopStrategy.java)
- [ArrayLoopStrategy.java](file://spring-ai-alibaba-agent-framework/src/main/java/com/alibaba/cloud/ai/graph/agent/flow/agent/loop/ArrayLoopStrategy.java)
- [LoopMode.java](file://spring-ai-alibaba-agent-framework/src/main/java/com/alibaba/cloud/ai/graph/agent/flow/agent/loop/LoopMode.java)
- [ReviewerTool.java](file://spring-ai-alibaba-agent-framework/src/test/java/com/alibaba/cloud/ai/graph/agent/tools/ReviewerTool.java)
- [PoetTool.java](file://spring-ai-alibaba-agent-framework/src/test/java/com/alibaba/cloud/ai/graph/agent/tools/PoetTool.java)
</cite>

## 目录
1. [工作流代理概述](#工作流代理概述)
2. [SequentialAgent](#sequentialagent)
3. [ParallelAgent](#parallelagent)
4. [SupervisorAgent](#supervisoragent)
5. [LlmRoutingAgent](#llmroutingagent)
6. [LoopAgent](#loopagent)
7. [配置示例与场景对比](#配置示例与场景对比)

## 工作流代理概述

工作流代理（FlowAgent）家族是Spring AI Alibaba框架中用于构建复杂代理工作流的核心组件。这些代理通过组合多个子代理来实现高级任务编排能力。所有工作流代理都继承自`FlowAgent`基类，该基类定义了工作流代理的基本结构和行为。

`FlowAgent`通过`FlowGraphBuilder`构建状态图，利用`buildSpecificGraph`抽象方法让子类定义特定的图构建策略。这种设计模式实现了工作流逻辑与图构建的解耦，使得每种代理类型可以独立实现其特有的执行模式。

```mermaid
classDiagram
class FlowAgent {
+String[] interruptBefore
+Agent[] subAgents
+StateSerializer stateSerializer
+FlowAgent(String, String, CompileConfig, Agent[])
+FlowAgent(String, String, CompileConfig, Agent[], StateSerializer)
+FlowAgent(String, String, CompileConfig, Agent[], StateSerializer, Executor)
+schedule(ScheduleConfig) ScheduledAgentTask
+asStateGraph() StateGraph
+subAgents() Agent[]
-buildSpecificGraph(FlowGraphConfig) StateGraph
}
class SequentialAgent {
+SequentialAgent(SequentialAgentBuilder)
+builder() SequentialAgentBuilder
-buildSpecificGraph(FlowGraphConfig) StateGraph
}
class ParallelAgent {
-MergeStrategy mergeStrategy
-String mergeOutputKey
-Integer maxConcurrency
+ParallelAgent(ParallelAgentBuilder)
+builder() ParallelAgentBuilder
+mergeStrategy() MergeStrategy
+mergeOutputKey() String
+maxConcurrency() Integer
-buildSpecificGraph(FlowGraphConfig) StateGraph
}
class SupervisorAgent {
-ChatModel chatModel
-String systemPrompt
-String instruction
+SupervisorAgent(SupervisorAgentBuilder)
+builder() SupervisorAgentBuilder
+getSystemPrompt() String
+getInstruction() String
-buildSpecificGraph(FlowGraphConfig) StateGraph
}
class LlmRoutingAgent {
-ChatModel chatModel
-String fallbackAgent
-String systemPrompt
-String instruction
+LlmRoutingAgent(LlmRoutingAgentBuilder)
+builder() LlmRoutingAgentBuilder
+getFallbackAgent() String
+getSystemPrompt() String
+getInstruction() String
-buildSpecificGraph(FlowGraphConfig) StateGraph
}
class LoopAgent {
-LoopStrategy loopStrategy
+LOOP_STRATEGY String
+LoopAgent(LoopAgentBuilder)
+builder() LoopAgentBuilder
-buildSpecificGraph(FlowGraphConfig) StateGraph
}
FlowAgent <|-- SequentialAgent
FlowAgent <|-- ParallelAgent
FlowAgent <|-- SupervisorAgent
FlowAgent <|-- LlmRoutingAgent
FlowAgent <|-- LoopAgent
```

**图源**  
- [FlowAgent.java](file://spring-ai-alibaba-agent-framework/src/main/java/com/alibaba/cloud/ai/graph/agent/flow/agent/FlowAgent.java)
- [SequentialAgent.java](file://spring-ai-alibaba-agent-framework/src/main/java/com/alibaba/cloud/ai/graph/agent/flow/agent/SequentialAgent.java)
- [ParallelAgent.java](file://spring-ai-alibaba-agent-framework/src/main/java/com/alibaba/cloud/ai/graph/agent/flow/agent/ParallelAgent.java)
- [SupervisorAgent.java](file://spring-ai-alibaba-agent-framework/src/main/java/com/alibaba/cloud/ai/graph/agent/flow/agent/SupervisorAgent.java)
- [LlmRoutingAgent.java](file://spring-ai-alibaba-agent-framework/src/main/java/com/alibaba/cloud/ai/graph/agent/flow/agent/LlmRoutingAgent.java)
- [LoopAgent.java](file://spring-ai-alibaba-agent-framework/src/main/java/com/alibaba/cloud/ai/graph/agent/flow/agent/LoopAgent.java)

**节源**  
- [FlowAgent.java](file://spring-ai-alibaba-agent-framework/src/main/java/com/alibaba/cloud/ai/graph/agent/flow/agent/FlowAgent.java)

## SequentialAgent

`SequentialAgent`实现了代理的顺序执行模式。它按照预定义的顺序依次执行子代理，每个代理的输出作为下一个代理的输入，形成一个线性的处理流水线。这种模式适用于需要按步骤处理的任务，如多阶段数据处理或分步决策流程。

`SequentialAgent`通过`FlowGraphBuilder`构建一个线性状态图，使用`SEQUENTIAL`类型策略。其构建过程简单直接，不需要复杂的并行或条件逻辑。代理的执行顺序由子代理在列表中的位置决定。

```mermaid
sequenceDiagram
participant Client as "客户端"
participant SequentialAgent as "SequentialAgent"
participant Agent1 as "子代理1"
participant Agent2 as "子代理2"
participant Agent3 as "子代理3"
Client->>SequentialAgent : 输入请求
SequentialAgent->>Agent1 : 执行代理1
Agent1-->>SequentialAgent : 返回结果1
SequentialAgent->>Agent2 : 传递结果1作为输入
Agent2-->>SequentialAgent : 返回结果2
SequentialAgent->>Agent3 : 传递结果2作为输入
Agent3-->>SequentialAgent : 返回最终结果
SequentialAgent-->>Client : 返回最终输出
Note over SequentialAgent,Agent3 : 按顺序执行子代理，形成线性工作流
```

**图源**  
- [SequentialAgent.java](file://spring-ai-alibaba-agent-framework/src/main/java/com/alibaba/cloud/ai/graph/agent/flow/agent/SequentialAgent.java)
- [FlowGraphBuilder.java](file://spring-ai-alibaba-agent-framework/src/main/java/com/alibaba/cloud/ai/graph/agent/flow/builder/FlowGraphBuilder.java)

**节源**  
- [SequentialAgent.java](file://spring-ai-alibaba-agent-framework/src/main/java/com/alibaba/cloud/ai/graph/agent/flow/agent/SequentialAgent.java)

## ParallelAgent

`ParallelAgent`实现了代理的并行执行机制，支持多个子代理同时执行。它采用"扇出-聚集"（Fan-Out/Gather）模式，将输入分发给所有子代理，并行执行后收集结果并进行聚合。这种模式显著提高了处理效率，特别适合可以并行处理的独立任务。

`ParallelAgent`通过`ParallelGraphBuildingStrategy`构建并行执行图。其核心是`MergeStrategy`接口，定义了结果聚合策略。代理支持多种内置的合并策略，包括默认映射、列表合并和字符串连接等。

```mermaid
flowchart TD
Start([输入数据]) --> Distribute["分发到所有子代理"]
Distribute --> Agent1["子代理1 (并行执行)"]
Distribute --> Agent2["子代理2 (并行执行)"]
Distribute --> Agent3["子代理3 (并行执行)"]
Distribute --> AgentN["子代理N (并行执行)"]
Agent1 --> Collect["收集所有结果"]
Agent2 --> Collect
Agent3 --> Collect
AgentN --> Collect
Collect --> Merge["应用合并策略"]
Merge --> Strategy1["默认合并策略: 创建结果映射"]
Merge --> Strategy2["列表合并策略: 将结果合并为列表"]
Merge --> Strategy3["连接合并策略: 将结果连接为字符串"]
Strategy1 --> Output["输出最终结果"]
Strategy2 --> Output
Strategy3 --> Output
classDef strategy fill:#e1f5fe,stroke:#039be5;
class Strategy1,Strategy2,Strategy3 strategy
style Distribute fill:#c8e6c9,stroke:#43a047
style Collect fill:#c8e6c9,stroke:#43a047
style Merge fill:#c8e6c9,stroke:#43a047
```

**图源**  
- [ParallelAgent.java](file://spring-ai-alibaba-agent-framework/src/main/java/com/alibaba/cloud/ai/graph/agent/flow/agent/ParallelAgent.java)
- [EnhancedParallelResultAggregator.java](file://spring-ai-alibaba-agent-framework/src/main/java/com/alibaba/cloud/ai/graph/agent/flow/node/EnhancedParallelResultAggregator.java)

**节源**  
- [ParallelAgent.java](file://spring-ai-alibaba-agent-framework/src/main/java/com/alibaba/cloud/ai/graph/agent/flow/agent/ParallelAgent.java)

## SupervisorAgent

`SupervisorAgent`作为"经理"角色，负责协调多个专家代理完成复杂任务。它利用LLM作为决策引擎，根据当前状态和任务要求动态选择下一个执行的代理。这种模式实现了智能的任务调度和资源分配，适用于需要动态决策的复杂工作流。

`SupervisorAgent`通过`SupervisorGraphBuildingStrategy`构建监督式执行图。它配置了专门的`ChatModel`用于决策，并可以设置系统提示和指令来指导LLM的决策过程。监督代理会根据任务上下文和子代理的能力，智能地分配任务。

```mermaid
sequenceDiagram
participant User as "用户"
participant Supervisor as "SupervisorAgent"
participant Poet as "PoetTool"
participant Reviewer as "ReviewerTool"
participant LLM as "LLM决策引擎"
User->>Supervisor : "帮我创作一首关于春天的诗"
Supervisor->>LLM : 分析任务需求
LLM-->>Supervisor : 决定先创作后评审
Supervisor->>Poet : 执行创作任务
Poet-->>Supervisor : 返回诗歌草稿
Supervisor->>LLM : 评估是否需要修改
LLM-->>Supervisor : 建议进行评审
Supervisor->>Reviewer : 执行评审任务
Reviewer-->>Supervisor : 返回评审意见
Supervisor->>LLM : 评估是否需要重新创作
LLM-->>Supervisor : 建议最终确认
Supervisor-->>User : 返回最终诗歌作品
Note over Supervisor,LLM : SupervisorAgent作为经理协调专家代理完成复杂任务
```

**图源**  
- [SupervisorAgent.java](file://spring-ai-alibaba-agent-framework/src/main/java/com/alibaba/cloud/ai/graph/agent/flow/agent/SupervisorAgent.java)
- [ReviewerTool.java](file://spring-ai-alibaba-agent-framework/src/test/java/com/alibaba/cloud/ai/graph/agent/tools/ReviewerTool.java)
- [PoetTool.java](file://spring-ai-alibaba-agent-framework/src/test/java/com/alibaba/cloud/ai/graph/agent/tools/PoetTool.java)

**节源**  
- [SupervisorAgent.java](file://spring-ai-alibaba-agent-framework/src/main/java/com/alibaba/cloud/ai/graph/agent/flow/agent/SupervisorAgent.java)

## LlmRoutingAgent

`LlmRoutingAgent`利用LLM作为路由器，根据输入动态选择下一个执行的代理。与`SupervisorAgent`不同，它更侧重于路由决策而非任务协调。代理根据输入内容、上下文和预定义的规则，智能地将请求路由到最合适的处理代理。

`LlmRoutingAgent`通过`RoutingGraphBuildingStrategy`构建路由图。它同样使用`ChatModel`进行决策，但更专注于路径选择。代理可以配置备用代理（fallback agent），当无法确定最佳路由时使用默认路径。

```mermaid
flowchart TD
Input([输入请求]) --> Analyze["LLM分析请求内容"]
Analyze --> Type1{"请求类型: 诗歌创作?"}
Analyze --> Type2{"请求类型: 诗歌评审?"}
Analyze --> Type3{"请求类型: 其他?"}
Type1 --> |是| Route1["路由到PoetTool"]
Type2 --> |是| Route2["路由到ReviewerTool"]
Type3 --> |是| Route3["路由到DefaultAgent"]
Route1 --> Execute1["执行诗歌创作"]
Route2 --> Execute2["执行诗歌评审"]
Route3 --> Execute3["执行默认处理"]
Execute1 --> Output["返回结果"]
Execute2 --> Output
Execute3 --> Output
classDef route fill:#ffecb3,stroke:#ffa000;
class Route1,Route2,Route3 route
style Analyze fill:#e1f5fe,stroke:#039be5
style Type1,Type2,Type3 fill:#f3e5f5,stroke:#8e24aa
```

**图源**  
- [LlmRoutingAgent.java](file://spring-ai-alibaba-agent-framework/src/main/java/com/alibaba/cloud/ai/graph/agent/flow/agent/LlmRoutingAgent.java)
- [ReviewerTool.java](file://spring-ai-alibaba-agent-framework/src/test/java/com/alibaba/cloud/ai/graph/agent/tools/ReviewerTool.java)
- [PoetTool.java](file://spring-ai-alibaba-agent-framework/src/test/java/com/alibaba/cloud/ai/graph/agent/tools/PoetTool.java)

**节源**  
- [LlmRoutingAgent.java](file://spring-ai-alibaba-agent-framework/src/main/java/com/alibaba/cloud/ai/graph/agent/flow/agent/LlmRoutingAgent.java)

## LoopAgent

`LoopAgent`实现了循环执行策略，支持多种循环模式。它可以在满足特定条件时重复执行子代理，适用于需要迭代处理的任务，如重试机制、数据批量处理或条件循环。

`LoopAgent`通过`LoopGraphBuildingStrategy`构建循环执行图。其核心是`LoopStrategy`接口，定义了循环控制逻辑。代理支持多种内置的循环策略，包括计数循环、条件循环和JSON数组循环等。

```mermaid
flowchart TD
Start([开始]) --> Init["初始化循环状态"]
Init --> Check{"循环条件检查"}
Check --> |继续| Execute["执行子代理"]
Execute --> Update["更新循环状态"]
Update --> Check
Check --> |结束| End([结束])
subgraph 循环策略
Count["计数循环策略: 执行固定次数"]
Condition["条件循环策略: 基于条件判断"]
Array["数组循环策略: 遍历JSON数组"]
end
style Count fill:#c8e6c9,stroke:#43a047
style Condition fill:#c8e6c9,stroke:#43a047
style Array fill:#c8e6c9,stroke:#43a047
classDef strategy fill:#e1f5fe,stroke:#039be5;
class Count,Condition,Array strategy
```

**图源**  
- [LoopAgent.java](file://spring-ai-alibaba-agent-framework/src/main/java/com/alibaba/cloud/ai/graph/agent/flow/agent/LoopAgent.java)
- [CountLoopStrategy.java](file://spring-ai-alibaba-agent-framework/src/main/java/com/alibaba/cloud/ai/graph/agent/flow/agent/loop/CountLoopStrategy.java)
- [ConditionLoopStrategy.java](file://spring-ai-alibaba-agent-framework/src/main/java/com/alibaba/cloud/ai/graph/agent/flow/agent/loop/ConditionLoopStrategy.java)
- [ArrayLoopStrategy.java](file://spring-ai-alibaba-agent-framework/src/main/java/com/alibaba/cloud/ai/graph/agent/flow/agent/loop/ArrayLoopStrategy.java)

**节源**  
- [LoopAgent.java](file://spring-ai-alibaba-agent-framework/src/main/java/com/alibaba/cloud/ai/graph/agent/flow/agent/LoopAgent.java)

## 配置示例与场景对比

不同工作流代理适用于不同的应用场景，选择合适的代理类型对于构建高效的工作流至关重要。以下是各种代理的配置示例和适用场景对比：

```mermaid
erDiagram
AGENT_TYPES {
string type PK
string description
string configuration_example
string use_cases
string performance_characteristics
}
STRATEGIES {
string strategy PK
string description
string implementation_class
string parameters
}
AGENT_TYPES ||--o{ STRATEGIES : "uses"
AGENT_TYPES {
"SequentialAgent" "顺序执行代理" "builder().subAgents(list)" "多阶段处理、线性工作流" "顺序执行，性能可预测"
"ParallelAgent" "并行执行代理" "builder().subAgents(list).mergeStrategy(strategy)" "独立任务并行处理" "并行执行，高吞吐量"
"SupervisorAgent" "监督协调代理" "builder().subAgents(list).model(chatModel)" "复杂任务协调、智能调度" "决策开销，灵活性高"
"LlmRoutingAgent" "LLM路由代理" "builder().subAgents(list).model(chatModel)" "智能路由、内容分发" "路由决策开销"
"LoopAgent" "循环执行代理" "builder().subAgent(agent).loopStrategy(strategy)" "迭代处理、重试机制" "循环开销，可控制"
}
STRATEGIES {
"DefaultMergeStrategy" "默认合并策略" "ParallelAgent$DefaultMergeStrategy" "无"
"ListMergeStrategy" "列表合并策略" "ParallelAgent$ListMergeStrategy" "无"
"ConcatenationMergeStrategy" "连接合并策略" "ParallelAgent$ConcatenationMergeStrategy" "separator"
"CountLoopStrategy" "计数循环策略" "CountLoopStrategy" "maxCount"
"ConditionLoopStrategy" "条件循环策略" "ConditionLoopStrategy" "messagePredicate"
"ArrayLoopStrategy" "数组循环策略" "ArrayLoopStrategy" "converter"
}
```

**图源**  
- [ParallelAgent.java](file://spring-ai-alibaba-agent-framework/src/main/java/com/alibaba/cloud/ai/graph/agent/flow/agent/ParallelAgent.java)
- [LoopAgent.java](file://spring-ai-alibaba-agent-framework/src/main/java/com/alibaba/cloud/ai/graph/agent/flow/agent/LoopAgent.java)
- [CountLoopStrategy.java](file://spring-ai-alibaba-agent-framework/src/main/java/com/alibaba/cloud/ai/graph/agent/flow/agent/loop/CountLoopStrategy.java)
- [ConditionLoopStrategy.java](file://spring-ai-alibaba-agent-framework/src/main/java/com/alibaba/cloud/ai/graph/agent/flow/agent/loop/ConditionLoopStrategy.java)
- [ArrayLoopStrategy.java](file://spring-ai-alibaba-agent-framework/src/main/java/com/alibaba/cloud/ai/graph/agent/flow/agent/loop/ArrayLoopStrategy.java)

**节源**  
- [ParallelAgent.java](file://spring-ai-alibaba-agent-framework/src/main/java/com/alibaba/cloud/ai/graph/agent/flow/agent/ParallelAgent.java)
- [LoopAgent.java](file://spring-ai-alibaba-agent-framework/src/main/java/com/alibaba/cloud/ai/graph/agent/flow/agent/LoopAgent.java)